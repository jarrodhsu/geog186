<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Bay Area Bikeshares</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
  </head>
  <body>

    <style>
      .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      }

      .legend {
        background-color: #fff;
        border-radius: 3px;
        bottom: 40px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.10);
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        padding: 10px;
        position: absolute;
        left: 10px;
        z-index: 1;
      }
      .legend h4 {
        margin: 0 0 10px;
      }

      .map-overlay {
        background-color: #fff;
        border-radius: 3px;
        top: 30px;
        font: 17px/12px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        padding: 15px;
        position: absolute;
        opacity: 0.7;
        right: 30px;
        z-index: 1;
      }
    </style>

    <div id='map'></div>

    <div class='map-overlay' id='features'><h2>Bay Area Bike Shares</h2><div id='pd'><p>Hover over a bike or dock for information!</p></div></div>


    <div id='legend' class='legend'>
      <h4>Legend</h4>
      <div><img src="harbor-blue-11.svg"> Ford GoBike Docking Station</div>
      <div><img src="harbor-black-11.svg" > JUMP e-Bike Charging Station</div>
      <div><img src="bicycle-black-15.svg"> Available JUMP e-Bike</div>
      <div><img src="harbor-green-11.svg"> BRite Bike Docking Station</div>
      <div><img src="bicycle-green-15.svg"> Available BRite Bike</div>
    </div>

    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiamFycm9kaHN1IiwiYSI6ImNqczNxNHhtNjAyOXE0NG8xcnJpeW1hcXUifQ.SoYjjAcKto7ld-X19RE0KQ';
      var bounds = [
        [-123.519052, 37.100180], // Southwest coordinates
        [-121.623270, 38.852946]  // Northeast coordinates
      ];
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/jarrodhsu/cjudeshs10l971gupubdjmq21',
        center: [-122.443, 37.753],
        zoom: 11.5,
        maxZoom: 17,
        minZoom: 9,
        maxBounds: bounds
      });

      map.on('load', function () {
        var popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false
        });


        //FORD GO BIKES
        map.addSource('gobike', { type: 'geojson', data: 'https://raw.githubusercontent.com/jarrodhsu/mapbox/master/gobike.geojson' });
        map.addLayer({
          "id": "gobike",
          "type": "symbol",
          "source": "gobike",
          "layout": {
            "icon-image": "harbor-blue-11" 
          }
        });
        var gbjson = (function () {
          var gbjson = null;
          $.ajax({
            'async': false,
            'global': false,
            'url': "https://gbfs.fordgobike.com/gbfs/en/station_status.json",
            'dataType': "json",
            'success': function (gbdata) {
              gbjson = gbdata;
            },
            'error': function (gb) {
              gbjson = gb;
            }
          });
          return gbjson;
        })(); 
        map.on('mouseenter', 'gobike', function(e) {
          map.getCanvas().style.cursor = 'pointer';
          function id(station) { return station['station_id'] == e.features[0].properties.station_id;}
          var coordinates = e.features[0].geometry.coordinates.slice();
          var description = gbjson['data']['stations'].find(id)['num_bikes_available'] + " bikes available";
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          popup.setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
        });
        map.on('mouseleave', 'gobike', function() {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });


        //JUMP STATIONS
        map.addSource('jumpstation', { type: 'geojson', data: 'https://raw.githubusercontent.com/jarrodhsu/mapbox/master/jump.geojson' });
        map.addLayer({
          "id": "jumpstation",
          "type": "symbol",
          "source": "jumpstation",
          "layout": {
            "icon-image": "harbor-black-11" 
          }
        });
        var jsjson = (function () {
          var jsjson = null;
          $.ajax({
            'async': false,
            'global': false,
            'url': "https://sf.jumpbikes.com/opendata/station_status.json",
            'dataType': "json",
            'success': function (jsdata) {
              jsjson = jsdata;
            }
          });
          return jsjson;
        })(); 
        map.on('mouseenter', 'jumpstation', function(e) {
          map.getCanvas().style.cursor = 'pointer';
          function id(station) { return station['station_id'] == e.features[0].properties.station_id;}
          var coordinates = e.features[0].geometry.coordinates.slice();
          var description = jsjson['data']['stations'].find(id)['num_bikes_available'] + " bikes available";
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          popup.setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
        });
        map.on('mouseleave', 'jumpstation', function() {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });



        //JUMP BIKES
        var jbjson = (function () {
          var jbjson = null;
          $.ajax({
            'async': false,
            'global': false,
            'url': "https://sf.jumpbikes.com/opendata/free_bike_status.json",
            'dataType': "json",
            'success': function (jbdata) {
              jbjson = jbdata;
            }
          });
          return jbjson;
        })(); 
        var jbjsonFeatures = [];
        jbjson['data']['bikes'].forEach(function(point){
            var lat = point.lat;
            var lon = point.lon;
            var feature = {type: 'Feature',
                properties: point,
                geometry: {
                    type: 'Point',
                    coordinates: [lon,lat]
                }
            };
            jbjsonFeatures.push(feature);
        });
        var jbgeoJson = { type: 'FeatureCollection', features: jbjsonFeatures };
        map.addSource('jumpbike', { type: 'geojson', data: jbgeoJson});
        map.addLayer({
          "id": "jumpbike",
          "type": "symbol",
          "source": "jumpbike",
          "layout": {
            "icon-image": "bicycle-black-15"
          }
        });
        map.on('mouseenter', 'jumpbike', function(e) {
          map.getCanvas().style.cursor = 'pointer';
          var coordinates = e.features[0].geometry.coordinates.slice();
          var description = "battery level: " + e.features[0].properties.jump_ebike_battery_level;
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          popup.setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
        });
        map.on('mouseleave', 'jumpbike', function() {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });



        //BRITE BIKES
        var bbjson = (function () {
          var bbjson = null;
          $.ajax({
            'async': false,
            'global': false,
            'url': "http://britebikes.socialbicycles.com/opendata/free_bike_status.json",
            'dataType': "json",
            'success': function (bbdata) {
              bbjson = bbdata;
            }
          });
          return bbjson;
        })(); 
        var bbjsonFeatures = [];
        bbjson['data']['bikes'].forEach(function(point){
            var lat = point.lat;
            var lon = point.lon;
            var feature = {type: 'Feature',
                properties: point,
                geometry: {
                    type: 'Point',
                    coordinates: [lon,lat]
                }
            };
            bbjsonFeatures.push(feature);
        });
        var bbgeoJson = { type: 'FeatureCollection', features: bbjsonFeatures };
        map.addSource('britebike', { type: 'geojson', data: bbgeoJson});
        map.addLayer({
          "id": "britebike",
          "type": "symbol",
          "source": "britebike",
          "layout": {
            "icon-image": "bicycle-green-15"
          }
        });
        map.on('mouseenter', 'britebike', function(e) {
          map.getCanvas().style.cursor = 'pointer';
          var coordinates = e.features[0].geometry.coordinates.slice();
          var description = "bike name: " + e.features[0].properties.name;
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          popup.setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
        });
        map.on('mouseleave', 'britebike', function() {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });

    

      //BRITE STATIONS
        var bsjson0 = (function () {
          var bsjson0 = null;
          $.ajax({
            'async': false,
            'global': false,
            'url': "http://britebikes.socialbicycles.com/opendata/station_information.json",
            'dataType': "json",
            'success': function (bsdata0) {
              bsjson0 = bsdata0;
            }
          });
          return bsjson0;
        })(); 
        var bsjsonFeatures = [];
        bsjson0['data']['stations'].forEach(function(point){
            var lat = point.lat;
            var lon = point.lon;
            var feature = {type: 'Feature',
                properties: point,
                geometry: {
                    type: 'Point',
                    coordinates: [lon,lat]
                }
            };
            bsjsonFeatures.push(feature);
        });
        var bsgeoJson = { type: 'FeatureCollection', features: bsjsonFeatures };
        map.addSource('britestation', { type: 'geojson', data: bsgeoJson});
        map.addLayer({
          "id": "britestation",
          "type": "symbol",
          "source": "britestation",
          "layout": {
            "icon-image": "harbor-green-11" 
          }
        });
        var bsjson = (function () {
          var bsjson = null;
          $.ajax({
            'async': false,
            'global': false,
            'url': "http://britebikes.socialbicycles.com/opendata/station_status.json",
            'dataType': "json",
            'success': function (bsdata) {
              bsjson = bsdata;
            }
          });
          return bsjson;
        })(); 
        map.on('mouseenter', 'britestation', function(e) {
          map.getCanvas().style.cursor = 'pointer';
          function id(station) { return station['station_id'] == e.features[0].properties.station_id;}
          var coordinates = e.features[0].geometry.coordinates.slice();
          var description = bsjson['data']['stations'].find(id)['num_bikes_available'] + " bikes available";
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          popup.setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
        });
        map.on('mouseleave', 'britestation', function() {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });
      });
      var stateLegendEl = document.getElementById('legend');

      //aggregate filter fixlegend
    </script>

  </body>
</html>